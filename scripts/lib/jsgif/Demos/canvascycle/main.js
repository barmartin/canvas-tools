var encoder=new GIFEncoder;encoder.setRepeat(0),encoder.setDelay(25),encoder.start(),FrameCount.visible=!1;var CanvasCycle={cookie:new CookieTree,ctx:null,imageData:null,clock:0,inGame:!1,bmp:null,globalTimeStart:(new Date).getTime(),inited:!1,optTween:null,winSize:null,globalBrightness:1,lastBrightness:0,sceneIdx:-1,highlightColor:-1,defaultMaxVolume:.5,settings:{showOptions:!1,targetFPS:60,zoomFull:!1,blendShiftEnabled:!0,speedAdjust:1,sound:!0},contentSize:{width:640,optionsWidth:0,height:520,scale:1},init:function(){if(!this.inited){this.inited=!0,$("container").style.display="block",$("d_options").style.display="none",FrameCount.init(),this.handleResize();for(var a=$("palette_display"),b=0,c=256;c>b;b++){var d=document.createElement("div");d._idx=b,d.id="pal_"+b,d.className="palette_color",d.onmouseover=function(){CanvasCycle.highlightColor=this._idx},d.onmouseout=function(){CanvasCycle.highlightColor=-1},a.appendChild(d)}var d=document.createElement("div");d.className="clear",a.appendChild(d);var e=0,f="";f+='<select id="fe_scene" onChange="CanvasCycle.switchScene(this)">';for(var b=0,c=scenes.length;c>b;b++){var g=scenes[b];f+='<option value="'+g.name+'" '+(b==e?' selected="selected"':"")+">"+g.title+"</option>"}f+="</select>",$("d_scene_selector").innerHTML=f;var h=this.cookie.get("settings");h&&(h.showOptions&&this.toggleOptions(),this.setRate(h.targetFPS),this.setZoom(h.zoomFull),this.setSpeed(h.speedAdjust),this.setBlendShift(h.blendShiftEnabled),this.setSound(h.sound)),location.href.match(/\bsound\=(\d+)/)&&this.setSound(!!parseInt(RegExp.$1,10)),this.loadImage(scenes[e].name),this.sceneIdx=e}},jumpScene:function(a){this.sceneIdx+=a,this.sceneIdx>=scenes.length?this.sceneIdx=0:this.sceneIdx<0&&(this.sceneIdx=scenes.length-1),$("fe_scene").selectedIndex=this.sceneIdx,this.switchScene($("fe_scene"))},switchScene:function(a){this.stopSceneAudio();var b=a.options[a.selectedIndex].value;this.sceneIdx=a.selectedIndex,ua.mobile?(this.inGame=!1,this.ctx.clearRect(0,0,this.bmp.width,this.bmp.height),this.ctx.fillStyle="rgb(0,0,0)",this.ctx.fillRect(0,0,this.bmp.width,this.bmp.height),CanvasCycle.globalBrightness=1,CanvasCycle.loadImage(b)):(TweenManager.removeAll({category:"scenefade"}),TweenManager.tween({target:{value:this.globalBrightness,newSceneName:b},duration:Math.floor(this.settings.targetFPS/2),mode:"EaseInOut",algo:"Quadratic",props:{value:0},onTweenUpdate:function(a){CanvasCycle.globalBrightness=a.target.value},onTweenComplete:function(a){CanvasCycle.loadImage(a.target.newSceneName)},category:"scenefade"}))},loadImage:function(a){var b=$("d_loading");b.style.left=""+Math.floor(this.contentSize.width*this.contentSize.scale/2-16)+"px",b.style.top=""+Math.floor(this.contentSize.height*this.contentSize.scale/2-16)+"px",b.show();var c="image.php?file="+a+"&callback=CanvasCycle.processImage",d=document.createElement("SCRIPT");d.type="text/javascript",d.src=c,document.getElementsByTagName("HEAD")[0].appendChild(d)},processImage:function(a){$("d_loading").hide(),this.bmp=new Bitmap(a),this.bmp.optimize();var b=$("mycanvas");if(b.getContext){if(this.ctx||(this.ctx=b.getContext("2d")),this.ctx.clearRect(0,0,this.bmp.width,this.bmp.height),this.ctx.fillStyle="rgb(0,0,0)",this.ctx.fillRect(0,0,this.bmp.width,this.bmp.height),!this.imageData)if(this.ctx.createImageData)this.imageData=this.ctx.createImageData(this.bmp.width,this.bmp.height);else{if(!this.ctx.getImageData)return;this.imageData=this.ctx.getImageData(0,0,this.bmp.width,this.bmp.height)}ua.mobile?this.globalBrightness=1:(this.globalBrightness=0,TweenManager.removeAll({category:"scenefade"}),TweenManager.tween({target:{value:0},duration:Math.floor(this.settings.targetFPS/2),mode:"EaseInOut",algo:"Quadratic",props:{value:1},onTweenUpdate:function(a){CanvasCycle.globalBrightness=a.target.value},category:"scenefade"})),this.inGame||(this.inGame=!0,this.animate()),this.startSceneAudio()}},animate:function(){if(this.inGame){var a=this.bmp.palette.colors;if(this.settings.showOptions){for(var b=0,c=a.length;c>b;b++){var d=a[b],e=$("pal_"+b);e.style.backgroundColor="rgb("+d.red+","+d.green+","+d.blue+")"}this.clock%this.settings.targetFPS==0&&($("d_debug").innerHTML="FPS: "+FrameCount.current)}this.bmp.palette.cycle(this.bmp.palette.baseColors,GetTickCount(),this.settings.speedAdjust,this.settings.blendShiftEnabled),this.highlightColor>-1&&(this.bmp.palette.colors[this.highlightColor]=new Color(255,255,255)),this.globalBrightness<1&&this.bmp.palette.burnOut(1-this.globalBrightness,1),this.bmp.render(this.imageData,this.lastBrightness==this.globalBrightness&&this.highlightColor==this.lastHighlightColor),this.lastBrightness=this.globalBrightness,this.lastHighlightColor=this.highlightColor,this.ctx.putImageData(this.imageData,0,0),TweenManager.logic(this.clock),this.clock++,FrameCount.count(),this.clock>100&&this.clock<110&&(encoder.addFrame(this.ctx),console.log("added frame")),this.inGame&&setTimeout(function(){CanvasCycle.animate()},1e3/this.settings.targetFPS)}},scaleAnimate:function(){if(this.settings.zoomFull){var a=this.contentSize.width+this.contentSize.optionsWidth,b=(this.winSize.width-30)/a,c=this.contentSize.height,d=(this.winSize.height-30)/c,e=Math.min(b,d);if(this.contentSize.scale!=e){this.contentSize.scale+=(e-this.contentSize.scale)/8,Math.abs(this.contentSize.scale-e)<.001&&(this.contentSize.scale=e);var f=$("mycanvas").style;ua.webkit?f.webkitTransform="translate3d(0px, 0px, 0px) scale("+this.contentSize.scale+")":ua.ff?f.MozTransform="scale("+this.contentSize.scale+")":ua.op?f.OTransform="scale("+this.contentSize.scale+")":f.transform="scale("+this.contentSize.scale+")",f.marginRight=""+Math.floor(this.contentSize.width*this.contentSize.scale-this.contentSize.width)+"px",$("d_header").style.width=""+Math.floor(this.contentSize.width*this.contentSize.scale)+"px",this.repositionContainer()}}else if(this.contentSize.scale>1){this.contentSize.scale+=(1-this.contentSize.scale)/8,this.contentSize.scale<1.001&&(this.contentSize.scale=1);var f=$("mycanvas").style;ua.webkit?f.webkitTransform="translate3d(0px, 0px, 0px) scale("+this.contentSize.scale+")":ua.ff?f.MozTransform="scale("+this.contentSize.scale+")":ua.op?f.OTransform="scale("+this.contentSize.scale+")":f.transform="scale("+this.contentSize.scale+")",f.marginRight=""+Math.floor(this.contentSize.width*this.contentSize.scale-this.contentSize.width)+"px",$("d_header").style.width=""+Math.floor(this.contentSize.width*this.contentSize.scale)+"px",this.repositionContainer()}},repositionContainer:function(){var a=$("container");a&&(this.winSize=getInnerWindowSize(),a.style.left=""+Math.floor(this.winSize.width/2-(this.contentSize.width*this.contentSize.scale+this.contentSize.optionsWidth)/2)+"px",a.style.top=""+Math.floor(this.winSize.height/2-this.contentSize.height*this.contentSize.scale/2)+"px")},handleResize:function(){this.repositionContainer(),this.settings.zoomFull&&this.scaleAnimate()},saveSettings:function(){this.cookie.set("settings",this.settings),this.cookie.save()},startSceneAudio:function(){var a=scenes[this.sceneIdx];if(a.sound&&this.settings.sound&&window.Audio){if(this.audioTrack)try{this.audioTrack.pause()}catch(b){}TweenManager.removeAll({category:"audio"});var c=ua.ff||ua.op?"ogg":"mp3",d=this.audioTrack=new Audio("audio/"+a.sound+"."+c);d.volume=0,d.loop=!0,d.autobuffer=!1,d.autoplay=!0,d.addEventListener("canplaythrough",function(){d.play(),TweenManager.tween({target:d,duration:Math.floor(2*CanvasCycle.settings.targetFPS),mode:"EaseOut",algo:"Linear",props:{volume:a.maxVolume||CanvasCycle.defaultMaxVolume},category:"audio"})},!1),(ua.iphone||ua.ipad)&&setTimeout(function(){d.play(),d.volume=1},1e3),(ua.ff||ua.mobile)&&d.addEventListener("ended",function(){d.currentTime=0,d.play()},!1),d.load()}},stopSceneAudio:function(){var a=scenes[this.sceneIdx];if(a.sound&&this.settings.sound&&window.Audio&&this.audioTrack){var b=this.audioTrack;ua.iphone||ua.ipad?b.pause():(TweenManager.removeAll({category:"audio"}),TweenManager.tween({target:b,duration:Math.floor(CanvasCycle.settings.targetFPS/2),mode:"EaseOut",algo:"Linear",props:{volume:0},onTweenComplete:function(){b.pause()},category:"audio"}))}},toggleOptions:function(){var a,b;TweenManager.removeAll({category:"options"}),this.settings.showOptions?(a=1,this.optTween&&(a=this.optTween.target.value),b=0,$("btn_options_toggle").innerHTML="Show Options &#x00BB;"):(a=0,this.optTween&&(a=this.optTween.target.value),b=1,$("d_options").style.display="",$("d_options").style.opacity=a,$("btn_options_toggle").innerHTML="&#x00AB; Hide Options"),this.optTween=TweenManager.tween({target:{value:a},duration:Math.floor(this.settings.targetFPS/3),mode:"EaseOut",algo:"Quadratic",props:{value:b},onTweenUpdate:function(a){$("d_options").style.opacity=a.target.value,$("btn_options_toggle").style.left=""+Math.floor(128*a.target.value)+"px",CanvasCycle.contentSize.optionsWidth=Math.floor(150*a.target.value),CanvasCycle.handleResize()},onTweenComplete:function(a){0==a.target.value&&($("d_options").style.display="none"),CanvasCycle.optTween=null},category:"options"}),this.settings.showOptions=!this.settings.showOptions,this.saveSettings()},setZoom:function(a){a!=this.settings.zoomFull&&(this.settings.zoomFull=a,this.saveSettings(),$("btn_zoom_actual").setClass("selected",!a),$("btn_zoom_max").setClass("selected",a))},setSound:function(a){$("btn_sound_on").setClass("selected",a),$("btn_sound_off").setClass("selected",!a),this.settings.sound=a,this.sceneIdx>-1&&(a?this.audioTrack?this.audioTrack.play():this.startSceneAudio():this.audioTrack&&this.audioTrack.pause()),this.saveSettings()},setRate:function(a){this.settings.targetFPS=a,this.saveSettings()},setSpeed:function(a){$("btn_speed_025").setClass("selected",.25==a),$("btn_speed_05").setClass("selected",.5==a),$("btn_speed_1").setClass("selected",1==a),$("btn_speed_2").setClass("selected",2==a),$("btn_speed_4").setClass("selected",4==a),this.settings.speedAdjust=a,this.saveSettings()},setBlendShift:function(a){$("btn_blendshift_on").setClass("selected",a),$("btn_blendshift_off").setClass("selected",!a),this.settings.blendShiftEnabled=a,this.saveSettings()}},CC=CanvasCycle;
//# sourceMappingURL=main.map